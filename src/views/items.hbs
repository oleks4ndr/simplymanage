<div class="catalog-container">
	<aside class="catalog-sidebar">
		<div class="filters">
			<h3 class="filters-title">Filters</h3>
			<form action="/items" method="GET" id="filterForm">
				<input type="hidden" name="search" value="{{search}}" />
				<input type="hidden" name="category" value="{{selectedCategory}}" id="categoryInput" />
				
				<div class="filter-group">
					<label class="filter-checkbox">
						<input
							type="checkbox"
							name="showOnlyAvailable"
							value="true"
							{{#if showOnlyAvailable}}checked{{/if}}
							onchange="document.getElementById('filterForm').submit()"
						/>
						<span>Show Only Available</span>
					</label>
				</div>
			</form>
		</div>

		<div class="categories">
			<h3 class="categories-title">
				<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
					<path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
				</svg>
				Categories
			</h3>
			<ul class="category-tree">
				<li>
					<a
						href="#"
						class="category-link {{#unless selectedCategory}}active{{/unless}}"
						onclick="selectCategory(event, '')"
					>
						<svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
							<path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
						</svg>
						All Items
					</a>
				</li>
				{{#each categories}}
					{{> categoryTreeItem}}
				{{/each}}
			</ul>
		</div>
	</aside>

	<main class="catalog-main">
		<div class="catalog-header">
			<div style="display: flex; flex-direction: column; gap: var(--space-xs);">
				<h1 class="catalog-title" style="margin: 0;">Catalog</h1>
				{{#if breadcrumb.length}}
					<nav aria-label="breadcrumb" style="display: flex; align-items: center; gap: var(--space-xs); font-size: 14px; color: var(--muted);">
						<a href="/items" style="color: var(--blue-600); text-decoration: none;">All Items</a>
						{{#each breadcrumb}}
							<svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="color: var(--slate-400);">
								<path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
							</svg>
							{{#if @last}}
								<span style="color: var(--dark); font-weight: 600;">{{cat_name}}</span>
							{{else}}
								<a href="#" onclick="selectCategory(event, '{{cat_id}}')" style="color: var(--blue-600); text-decoration: none;">{{cat_name}}</a>
							{{/if}}
						{{/each}}
					</nav>
				{{/if}}
			</div>
			{{#if isStaff}}
				<div style="display: flex; gap: var(--space-sm);">
					<a href="/categories" class="btn btn-ghost">
						<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="margin-right: 8px;">
							<path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
						</svg>
						Edit Categories
					</a>
					<a href="/items/add" class="btn btn-primary">
						<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="margin-right: 8px;">
							<path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
						</svg>
						Add Item
					</a>
				</div>
			{{/if}}
			<form action="/items" method="GET" class="search-form">
				<input type="hidden" name="category" value="{{selectedCategory}}" />
				<input type="hidden" name="showOnlyAvailable" value="{{showOnlyAvailable}}" />
				<input
					type="text"
					name="search"
					placeholder="Search"
					value="{{search}}"
					class="search-input"
				/>
				<button type="submit" class="search-button">
					<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
						<path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
					</svg>
				</button>
			</form>
		</div>

		{{#if items.length}}
			<div class="items-grid">
				{{#each items}}
					{{> itemCard}}
				{{/each}}
			</div>
		{{else}}
			<div class="empty-state">
				<p>No items found matching your criteria.</p>
				<a href="/items" class="btn btn-primary">Clear Filters</a>
			</div>
		{{/if}}
	</main>
</div>

<script>
	function selectCategory(event, categoryId) {
		event.preventDefault();
		document.getElementById('categoryInput').value = categoryId;
		document.getElementById('filterForm').submit();
	}

	function toggleCategory(event, categoryId) {
		event.stopPropagation();
		const childrenList = document.getElementById(categoryId);
		const button = event.currentTarget;
		const chevron = button.querySelector('.chevron');
		
		if (childrenList.style.display === 'none') {
			childrenList.style.display = 'block';
			chevron.style.transform = 'rotate(90deg)';
		} else {
			childrenList.style.display = 'none';
			chevron.style.transform = 'rotate(0deg)';
		}
	}
</script>
