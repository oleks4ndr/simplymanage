<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
    <div>
      <a href="/admin" style="font-size: 13px; color: var(--blue-500); text-decoration: none; margin-bottom: var(--space-sm); display: inline-block;">← Back to Dashboard</a>
      <h1 style="margin: 0;">Item Modifications Audit History</h1>
    </div>
  </div>

  {{#if flash}}
    <div class="alert alert-{{flash.type}}">{{flash.message}}</div>
  {{/if}}

  <!-- Filters -->
  <div class="card" style="margin-bottom: var(--space-xl);">
    <form method="GET" action="/admin/audit/modifications" style="display: flex; gap: var(--space-md); align-items: end;">
      <div class="form-group" style="flex: 1;">
        <label>Action Type</label>
        <select name="actionType" style="width: 100%; padding: var(--space-sm); border: 1px solid var(--slate-200); border-radius: 6px;">
          <option value="">All Actions</option>
          <option value="INSERT" {{#if (eq filter.actionType 'INSERT')}}selected{{/if}}>Insert</option>
          <option value="UPDATE" {{#if (eq filter.actionType 'UPDATE')}}selected{{/if}}>Update</option>
          <option value="DELETE" {{#if (eq filter.actionType 'DELETE')}}selected{{/if}}>Delete</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Apply Filters</button>
      <a href="/admin/audit/modifications" class="btn btn-ghost">Clear</a>
    </form>
  </div>

  <!-- Audit Table -->
  <div class="card">
    {{#if modifications.length}}
      <div style="display: flex; flex-direction: column; gap: var(--space-lg);">
        {{#each modifications}}
          <div style="border: 1px solid var(--slate-200); border-radius: 8px; overflow: hidden;">
            <!-- Header -->
            <div style="background: var(--slate-50); padding: var(--space-md); border-bottom: 1px solid var(--slate-200); display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="font-weight: 700; font-size: 16px; color: var(--dark);">
                  {{#if it_name}}
                    {{it_name}}
                  {{else}}
                    Item #{{it_id}}
                  {{/if}}
                </span>
                <span style="margin-left: var(--space-md); font-size: 12px; color: var(--muted);">ID: {{it_id}}</span>
              </div>
              <div style="display: flex; gap: var(--space-md); align-items: center;">
                <span class="badge {{#if (eq action_type 'INSERT')}}badge-success{{else}}{{#if (eq action_type 'UPDATE')}}badge-primary{{else}}badge-unavailable{{/if}}{{/if}}">
                  {{action_type}}
                </span>
                <span style="font-size: 13px; color: var(--muted);">{{modified_at}}</span>
              </div>
            </div>

            <!-- Details -->
            <div style="padding: var(--space-lg);">
              {{#if (eq action_type 'INSERT')}}
                <!-- INSERT: Show new info -->
                {{#if new_info_parsed}}
                  <h4 style="font-size: 13px; font-weight: 700; color: var(--muted); margin-bottom: var(--space-md); text-transform: uppercase;">New Item Details</h4>
                  <div style="background: #ecfdf5; padding: var(--space-md); border-radius: 6px; border: 1px solid #d1fae5;">
                    <pre style="margin: 0; font-size: 13px; color: var(--dark); white-space: pre-wrap; word-wrap: break-word; font-family: 'Monaco', 'Courier New', monospace;">{{json new_info_parsed}}</pre>
                  </div>
                {{/if}}
              {{else}}{{#if (eq action_type 'DELETE')}}
                <!-- DELETE: Show old info -->
                {{#if old_info_parsed}}
                  <h4 style="font-size: 13px; font-weight: 700; color: var(--muted); margin-bottom: var(--space-md); text-transform: uppercase;">Deleted Item Details</h4>
                  <div style="background: #fee2e2; padding: var(--space-md); border-radius: 6px; border: 1px solid #fca5a5;">
                    <pre style="margin: 0; font-size: 13px; color: var(--dark); white-space: pre-wrap; word-wrap: break-word; font-family: 'Monaco', 'Courier New', monospace;">{{json old_info_parsed}}</pre>
                  </div>
                {{/if}}
              {{else}}
                <!-- UPDATE: Show side-by-side comparison -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                  <div>
                    <h4 style="font-size: 13px; font-weight: 700; color: var(--muted); margin-bottom: var(--space-md); text-transform: uppercase;">Before</h4>
                    {{#if old_info_parsed}}
                      <div style="background: #fef3c7; padding: var(--space-md); border-radius: 6px; border: 1px solid #fde68a;">
                        <pre style="margin: 0; font-size: 12px; color: var(--dark); white-space: pre-wrap; word-wrap: break-word; font-family: 'Monaco', 'Courier New', monospace;">{{json old_info_parsed}}</pre>
                      </div>
                    {{/if}}
                  </div>
                  <div>
                    <h4 style="font-size: 13px; font-weight: 700; color: var(--muted); margin-bottom: var(--space-md); text-transform: uppercase;">After</h4>
                    {{#if new_info_parsed}}
                      <div style="background: #ecfdf5; padding: var(--space-md); border-radius: 6px; border: 1px solid #d1fae5;">
                        <pre style="margin: 0; font-size: 12px; color: var(--dark); white-space: pre-wrap; word-wrap: break-word; font-family: 'Monaco', 'Courier New', monospace;">{{json new_info_parsed}}</pre>
                      </div>
                    {{/if}}
                  </div>
                </div>
              {{/if}}{{/if}}
            </div>
          </div>
        {{/each}}
      </div>

      <!-- Pagination -->
      {{#if (gt pagination.totalPages 1)}}
        <div style="display: flex; justify-content: center; align-items: center; gap: var(--space-md); margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 1px solid var(--slate-200);">
          {{#if (gt pagination.currentPage 1)}}
            <a href="?page={{subtract pagination.currentPage 1}}{{#if filter.actionType}}&actionType={{filter.actionType}}{{/if}}" class="btn btn-sm btn-ghost">← Previous</a>
          {{/if}}
          
          <span style="font-size: 14px; color: var(--muted);">
            Page {{pagination.currentPage}} of {{pagination.totalPages}} ({{pagination.totalRecords}} records)
          </span>
          
          {{#if (lt pagination.currentPage pagination.totalPages)}}
            <a href="?page={{add pagination.currentPage 1}}{{#if filter.actionType}}&actionType={{filter.actionType}}{{/if}}" class="btn btn-sm btn-ghost">Next →</a>
          {{/if}}
        </div>
      {{/if}}
    {{else}}
      <div style="text-align: center; padding: var(--space-4xl);">
        <p style="font-size: 16px; color: var(--muted); margin-bottom: var(--space-xl);">No modification records found</p>
      </div>
    {{/if}}
  </div>
</div>
